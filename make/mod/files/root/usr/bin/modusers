#!/bin/sh
#save/load users and groups from/to flash (not TFFS)

SAVE_DIR=/tmp/flash/users
FILES="passwd group shadow gshadow"

save() {
	[ ! -e /tmp/.usersloaded ] && return 1
	rm -rf $SAVE_DIR
	mkdir -pm 700 $SAVE_DIR
	for f in $FILES; do
		cat "/tmp/$f" > "$SAVE_DIR/$f" 2>/dev/null
	done
}

load() {
	mkdir -pm 700 $SAVE_DIR
	for f in $FILES; do
		grep -vE "^boxusr|^ftpuser" "$SAVE_DIR/$f" > "/tmp/$f" 2>/dev/null
	done
	grep -q "^ftpuser" /etc/passxx || grep ^ftpuser "$SAVE_DIR/passwd" >> /etc/passwd
	grep -E "^boxusr|^ftpuser" /etc/passxx >> /etc/passwd
	[ $(cat /etc/passxx | wc -l) -le 1 ] && grep -E "^boxusr" "$SAVE_DIR/passwd" >> /etc/passwd
	touch /tmp/.usersloaded
}

case $1 in
	save)
		save
		;;
	load)
		load
		;;
	update)
		save
		load
		;;
	*)
		echo "Usage: $0 [load|save|update]" 1>&2
		exit 1
		;;
esac
